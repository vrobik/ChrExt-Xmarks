function XmarksQuotaManager(){this.sustained_buckets={};this.max_write_buckets={};this.refill_interval=6E4;this.refill_tokens=2;this.max_exhaustions=10;this.max_write_tokens=100;this.max_write_interval=36E5;this.max_attempts=5}XmarksQuotaManager.prototype.reset_sustained=function(b,a,c){b.tokens=this.refill_tokens;b.exp_time=a+this.refill_interval;c&&(b.num_exhausted=this.max_exhaustions)};
XmarksQuotaManager.prototype.check_sustained=function(b,a){bucket=this.sustained_buckets[b];bucket||(this.sustained_buckets[b]=bucket={},this.reset_sustained(bucket,a,!0));if(a>bucket.exp_time)if(0<=bucket.tokens||a>bucket.exp_time+this.refill_interval)this.reset_sustained(bucket,a,!0);else if(0<--bucket.num_exhausted)this.reset_sustained(bucket,a,!1);else return!1;bucket.tokens--;return!0};XmarksQuotaManager.prototype.reset_max_write=function(b,a){b.tokens=this.max_write_tokens;b.exp_time=a+this.max_write_interval};
XmarksQuotaManager.prototype.check_max_write=function(b,a){bucket=this.max_write_buckets[b];bucket||(this.max_write_buckets[b]=bucket={},this.reset_max_write(bucket,a));a>bucket.exp_time&&this.reset_max_write(bucket,a);bucket.tokens--;return 0<=bucket.tokens};XmarksQuotaManager.prototype.would_hit_quota=function(b){var a=(new Date).getTime();return!this.check_sustained(b,a)||!this.check_max_write(b,a)};XmarksQuotaManager.prototype.quota_check=function(b,a,c){return this.quota_recheck(0,b,a,c)};
XmarksQuotaManager.prototype.quota_recheck=function(b,a,c,d){var e=this;if(b>this.max_attempts)throw Error("Too many consecutive quota failures!  Giving up.");var f=(new Date).getTime();this.check_sustained(a,f)?this.check_max_write(a,f)?c.apply(this,d):(Xmarks.LogWrite("Chrome max write quota would be exceeded, waiting "+1.1*this.max_write_interval/1E3+" seconds"),setTimeout(function(){e.quota_recheck(b+1,a,c,d)},1.1*this.max_write_interval)):(Xmarks.LogWrite("Chrome sustained quota would be exceeded, waiting "+
1.1*this.refill_interval/1E3+" seconds"),setTimeout(function(){e.quota_recheck(b+1,a,c,d)},1.1*this.refill_interval))};
