function PinManager(){}
PinManager.EnablePasswordSync=function(a,e){function d(f){if(f.error)$(a).html(f.error+" Disabling password synchronization."),$(a).dialog("option","buttons",{Ok:function(){$(this).dialog("close")}});else if(!f.nodes||!f.nodes.ROOT||!f.nodes.ROOT.data)b.Xmarks.LogWrite("Enable passwords case 3"),PinManager.CreatePin(a,e);else{b.Xmarks.LogWrite("Enable passwords case 4");var d=f.nodes.ROOT.data;$(a).html('Please verify your password PIN to access your Xmarks passwords: <br /><div style="margin: 1em"><input type="password" id="password-pin"/> <br /><input style="margin-left: 1em" type="checkbox" id="pin-remember" checked="checked"> <label for="pin-remember">Remember PIN</label></div><div style="color: red; font-style: italic; display: none" id="password-pin-fail">Invalid PIN, please try again.</div>');$(a).dialog("option",
"buttons",{"I forgot my PIN":g,Confirm:function(){c(b.PasswordStore.VerifyPinData,b.PasswordStore,d)}});$(a).dialog("open");document.getElementById("password-pin").addEventListener("keydown",function(){document.getElementById("password-pin-fail").style.display="none"});document.getElementById("password-pin").addEventListener("keyup",function(a){13==a.keyCode&&c(b.PasswordStore.VerifyPinData,b.PasswordStore,d)});document.getElementById("password-pin").focus()}}function c(c,d,g){c.call(d,document.getElementById("password-pin").value,
g)?(b.TurnOnPasswordSync(document.getElementById("password-pin").value,document.getElementById("pin-remember").checked),$(a).dialog("close"),e&&e()):(document.getElementById("password-pin-fail").style.display="block",document.getElementById("password-pin").value="",document.getElementById("password-pin").focus())}function g(){$(a).html("Unfortunately we cannot recover your PIN or your access your Xmarks passwords.  You can either reset your PIN and clear all of your password data or cancel and disable password sync for this computer.");
$(a).dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},"Reset PIN":function(){PinManager.ResetPin(a,e)}});$(a).dialog("open")}$(a).html("Initializing password synchronization.");$(a).dialog("option","buttons",{});$(a).dialog("open");var b=chrome.extension.getBackgroundPage();b.AuthenticateUser(function(){var f=b.Xmarks.Settings.GetUserSettings();f.username?f.passwordsrevision?b.Xmarks.Settings.Get(b.Xmarks.Settings.GetUserHash()+"password-pin")?(b.Xmarks.LogWrite("Enable passwords case 1"),
b.TurnOnPasswordSync(b.Base64.decode(b.Xmarks.Settings.Get(b.Xmarks.Settings.GetUserHash()+"password-pin")),!0),$(a).dialog("close"),e()):(b.Xmarks.LogWrite("Enable passwords case 2"),$(a).html('This browser already has Xmarks encrypted passwords.  Please verify your password PIN to access your existing passwords: <br /><div style="margin: 1em"><input type="password" id="password-pin"/> <br /><input style="margin-left: 1em" type="checkbox" id="pin-remember" checked="checked"> <label for="pin-remember">Remember PIN</label></div><div style="color: red; font-style: italic; display: none" id="password-pin-fail">Invalid PIN, please try again.</div>'),
$(a).dialog("option","buttons",{"I forgot my PIN":g,Confirm:function(){c(b.PasswordStore.DoesPinUnlockLocalData,b.PasswordStore)}}),$(a).dialog("open"),document.getElementById("password-pin").addEventListener("keydown",function(){document.getElementById("password-pin-fail").style.display="none"}),document.getElementById("password-pin").addEventListener("keyup",function(a){13==a.keyCode&&c(b.PasswordStore.DoesPinUnlockLocalData,b.PasswordStore)}),document.getElementById("password-pin").focus()):b.GetPasswordState(d):
($(a).html("User authentication canceled, turning off password sync."),$(a).dialog("option","buttons",{Ok:function(){$(this).dialog("close")}}),$(a).dialog("open"))})};
PinManager.VerifyCurrentPin=function(a,e){function d(){c.Xmarks.Settings.Get(c.Xmarks.Settings.GetUserHash()+"password-pin")!=c.Base64.encode(document.getElementById("password-pin").value)?(document.getElementById("password-pin-fail").style.display="block",document.getElementById("password-pin").value="",document.getElementById("password-pin").focus()):($(a).dialog("close"),e())}var c=chrome.extension.getBackgroundPage();"false"==c.Xmarks.Settings.Get("sync-type-passwords","false")?($(a).html("Password sync is currently disabled.  You must enable password sync first."),
$(a).dialog("option","buttons",{Ok:function(){$(this).dialog("close")}}),$(a).dialog("open")):($(a).html('Please verify your password PIN: <br /><input style="margin: 1em" type="password" id="password-pin"/> <br /><div style="color: red; font-style: italic; display: none" id="password-pin-fail">Invalid PIN, please try again.</div>'),$(a).dialog("option","buttons",{Confirm:d}),$(a).dialog("open"),document.getElementById("password-pin").addEventListener("keydown",function(){document.getElementById("password-pin-fail").style.display=
"none"}),document.getElementById("password-pin").addEventListener("keyup",function(a){13==a.keyCode&&d()}),document.getElementById("password-pin").focus())};PinManager.ResetPin=function(a,e){$(a).html("<strong>Are you sure you want to reset your PIN?</strong> This will erase all of your current Xmarks password data.");$(a).dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},"Reset PIN":function(){PinManager.CreatePin(a,e)}});$(a).dialog("open")};
PinManager.CreatePin=function(a,e){function d(){var b=null;document.getElementById("password-pin1").value!=document.getElementById("password-pin2").value?b="The PINs you entered do not match.":4>document.getElementById("password-pin1").value.length?b="The PIN is too short, it must be at least 4 characters long.":255<document.getElementById("password-pin1").value.length&&(b="The PIN is too long, it must be no more than 255 characters long.");b?($(a).html("<div><strong>PIN Error</strong>: "+b+"</div>"+
g),document.getElementById("password-pin1").focus()):(chrome.extension.getBackgroundPage().TurnOnPasswordSync(document.getElementById("password-pin1").value,document.getElementById("pin-remember").checked),$(a).html("Your PIN was successfully created.  We will use this PIN to secure your passwords before we sync them so that only you can ever access them.  <strong>Do not lose this PIN</strong>, Xmarks cannot help you retrieve it."),$(a).dialog("option","buttons",{Close:c}),$(a).dialog("open"))}function c(){$(this).dialog("close");
chrome.extension.getBackgroundPage().HandleAction("upload",{dataType:"passwords"});e&&e()}var g='<div id="xmdiv" style="margin: 1em 1em 0 1em; white-space: nowrap;">New PIN: <input type="password" id="password-pin1"/></div><div style="margin: 0 1em 0.25em 1em; white-space: nowrap;">Confirm: <input type="password" id="password-pin2"/><br /><input type="checkbox" id="pin-remember" checked="checked"> <label for="pin-remember">Remember PIN</label></div><div id="password-strength" style="text-align: center; font-size: 10pt"></div>';
$(a).html("<div>Xmarks secures your passwords by encrypting them with a prive PIN of your choosing.  It's important that you remember this PIN because we cannot retrieve it for you.  Your PIN can be any combination of letters, numbers and symbols.</div>"+g);$(a).dialog("option","buttons",{"Create PIN":d});$(a).dialog("open");document.getElementById("xmdiv").addEventListener("input",function(){PinManager.PinStrength("password-pin1","password-strength")});document.getElementById("password-pin1").addEventListener("keyup",
function(a){13==a.keyCode&&d()});document.getElementById("password-pin2").addEventListener("keyup",function(a){13==a.keyCode&&d()});document.getElementById("password-pin1").focus()};PinManager.pinInputTimer=null;
PinManager.PinStrength=function(a,e){PinManager.pinInputTimer&&(window.clearTimeout(PinManager.pinInputTimer),PinManager.pinInputTimer=null);PinManager.pinInputTimer=window.setTimeout(function(){var d=document.getElementById(a).value,c=TestPassword(d),g="Strong",b="#2A911B",f=5*c;4>d.length?(g="Too short",b="#333333",f=0):17>c?(g="Weak",b="#57040F"):24>c?(g="Good",b="#ED9D2B"):40<c&&(f=200);document.getElementById(e).innerHTML="PIN strength: "+g+'<div style="text-align: center; border: 1px solid #ccc; width: 200px; margin-top: 5px; margin: auto; padding: 1px; background: white;"><div style="background-color: '+
b+"; height: 10px; width: "+f+'px"></div></div>'},300)};
