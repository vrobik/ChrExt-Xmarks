function Request(c,a,b,d,e,f,g){this._callback=this._channel=null;this._triedAuth=!1;this._headers=e;this._ignoreBody=f;this._ignoreAuthTokens=g;a instanceof Object?(a.protocol||(a.protocol=1==Xmarks.Settings.GetInt("securityLevel",1)||0==Xmarks.Settings.GetInt("securityLevel",0)&&d?"https":"http"),a.host||(a.host=Xmarks.Settings.Get("syncserver")),a.path||(a.path="/"),"/"!=a.path[0]&&(a.path="/"+a.path),this._url=a.protocol+"://"+a.host+a.path):this._url=a;this._bodyobj=b;this._method=c;this._isAuthRequest=
d}
Request.prototype={Start:function(c){Xmarks.LogWrite(">>> "+this._method+" "+this._StripPassword(this._url));this._bodyobj&&!this._isAuthRequest&&Xmarks.LogWrite(">>> Body is: "+(!Xmarks.Settings.GetBool("no-verbose")?JSON.stringify(this._bodyobj):"(disabled)"));this._callback=c;this._channel=new XMLHttpRequest;this._channel.open("POST",this._url,!0);(c=Xmarks.Settings.Get(Xmarks.Settings.GetUserHash()+"authtoken"))&&this._channel.setRequestHeader("x-xmarks-auth",c);this._channel.setRequestHeader("Content-Type","application/json; charset=utf-8");
this._channel.setRequestHeader("X-Xmarks-User-Agent","Xmarks-Cr/"+Xmarks.Settings.Get("version","???"));if(this._headers)for(var a in this._headers)this._channel.setRequestHeader(a,this._headers[a]);var b=this;this._channel.onreadystatechange=function(){b.onStreamComplete(b)};a=this._bodyobj?JSON.stringify(this._bodyobj):null;this._channel.send(a)},Cancel:function(){this._channel&&(Xmarks.LogWrite("Cancelling Network Request"),this._channel.abort())},onStreamComplete:function(c){var a={};if(4==c._channel.readyState){var b=
c._channel.status;if(200==b||201==b||204==b){this._ignoreBody||(a=JSON.parse(c._channel.responseText));null==a.status&&(a.status=0);if(302==a.status){Xmarks.LogWrite(">>> Authenticating...");if(this._triedAuth){Xmarks.LogWrite("In authentication loop. Possible proxy server caching issue.");this._callback({status:1012});return}a=a.authtoken_location;c=this;var b=a.indexOf("://"),d=a.indexOf("/",b+3);if(0>b||0>d)throw Error("Couldn't parse location string "+a);var e={};e.host=a.substr(b+3,d-(b+3));
e.host=Xmarks.Settings.Get("host-login",e.host);e.path=a.substr(d);Xmarks.GetUserCredentials(function(a){if(a.username){var b=Base64.decode(a.password),b=new Request("POST",e,Xmarks.GetRequestArgs({username:a.username,passwordhash:hex_md5(b)}),!0);c._triedAuth=!0;b.Start(function(b){0==b.status?(a.authtoken=b.auth,Xmarks.Settings.SetUserSettings(a),Xmarks.LogWrite("Authenticated as: "+Xmarks.Settings.Get("current-username")),UpdateTabListener(),c.Start(c._callback)):("Wrong username or password."==
b.message&&(b.status=401),c._callback(b))})}else Xmarks.LogWrite("User canceled password request."),c._callback(2)});return}503==a.status&&(d=new Date,b=60,"undefined"!=typeof responseBody&&"undefined"!=typeof responseBody.backoff_delay&&(b=responseBody.backoff_delay),d=d.getTime()+1E3*b,Xmarks.Settings.Set("backoff-until",d),Xmarks.LogWrite("Server 503: wants us to back off for "+b+" seconds"),Xmarks.LogWrite("Response: "+JSON.stringify(a)),a={status:-5,errormsg:"Server 503 delay"})}else a={status:-3,
errormsg:"Unknown HTTP response: "+b,text:c._channel.statusText,len:"undefined"!=typeof c._channel.responseText?c._channel.responseText.length:0,seclevel:Xmarks.Settings.GetInt("securityLevel",1)};Xmarks.Settings.GetBool("no-verbose")?Xmarks.LogWrite(">>> Callback (disabled)"):(b=a.auth,delete a.auth,Xmarks.LogWrite(">>> Callback "+JSON.stringify(a)),a.auth=b);this._callback(a)}},_StripPassword:function(c){var a=c.match(/^(.*):(.*)@(.*)$/);return a?a[1]+"@"+a[3]:c}};
